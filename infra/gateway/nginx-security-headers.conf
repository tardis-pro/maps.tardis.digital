# Nginx Security Headers Configuration
# This file contains security header configurations for Nginx
# Include this in your server block or as a separate file

# ============================================
# Content Security Policy (CSP) Configuration
# ============================================

# Basic CSP for development (permissive for testing)
# Note: In production, you should use the stricter version below
map $uri $csp_header {
    default "";
    
    # API endpoints don't need CSP
    ~^/api/ "";
    
    # Health endpoints don't need CSP
    ~^/health "";
    ~^/ready "";
    
    # Static assets can have relaxed CSP
    ~*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ "";
    
    # HTML responses get full CSP
    ~* \.html?$ "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; form-action 'self'; base-uri 'self'";
}

# ============================================
# Production CSP - Strict Policy
# ============================================

# Uncomment this for production with trusted CDNs
# map $uri $csp_header_strict {
#     default "";
#     ~^/api/ "";
#     ~^/health "";
#     ~^/ready "";
#     ~*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ "";
#     ~* \.html?$ "default-src 'self'; script-src 'self' https://cdn.example.com; style-src 'self' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.example.com; frame-ancestors 'none'; form-action 'self'; base-uri 'self'; upgrade-insecure-requests";
# }

# ============================================
# Nginx Server Block Example
# ============================================

# server {
#     listen 443 ssl http2;
#     server_name maps.tardis.digital;
# 
#     # SSL Configuration
#     ssl_certificate /etc/ssl/certs/maps.tardis.digital.crt;
#     ssl_certificate_key /etc/ssl/private/maps.tardis.digital.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 1d;
# 
#     # HTTP Strict Transport Security (HSTS)
#     # Uncomment for production (requires valid SSL certificate)
#     add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
# 
#     # Content Security Policy
#     add_header Content-Security-Policy $csp_header always;
# 
#     # Additional Security Headers
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-Frame-Options "DENY" always;
#     add_header X-Robots-Tag "noindex, nofollow" always;
#     add_header Referrer-Policy "strict-origin-when-cross-origin" always;
#     add_header Permissions-Policy "geolocation=(), microphone=(), payment=(), camera=()" always;
# 
#     # Cross-Origin policies
#     add_header Cross-Origin-Opener-Policy "same-origin" always;
#     add_header Cross-Origin-Resource-Policy "same-origin" always;
# 
#     # Cache-Control for static assets
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         add_header X-Content-Type-Options "nosniff" always;
#     }
# 
#     # API Proxy to FastAPI
#     location /api/ {
#         proxy_pass http://127.0.0.1:8000/;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }
# 
#     # Health check endpoint
#     location /health {
#         proxy_pass http://127.0.0.1:8000/health;
#         proxy_set_header Host $host;
#     }
# 
#     # Frontend static files
#     location / {
#         root /usr/share/nginx/html;
#         try_files $uri $uri/ /index.html;
#         index index.html;
#     }
# 
#     # CSP Report endpoint (for receiving CSP violation reports)
#     location /api/v1/security/csp-report {
#         # Log CSP violations or send to external service
#         access_log /var/log/nginx/csp-violations.log;
#         return 204;
#     }
# }

# ============================================
# HTTP to HTTPS Redirect
# ============================================

# server {
#     listen 80;
#     server_name maps.tardis.digital;
# 
#     # HSTS preloading (uncomment for production)
#     # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
# 
#     return 301 https://$host$request_uri;
# }

# ============================================
# Rate Limiting in Nginx (Optional)
# ============================================

# limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
# limit_conn_zone $binary_remote_addr zone=conn:10m;

# location /api/ {
#     limit_req zone=api burst=20 nodelay;
#     limit_conn conn 10;
#     proxy_pass http://127.0.0.1:8000/;
#     # ... other proxy settings
# }
